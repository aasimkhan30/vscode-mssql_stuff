name: Issue Handler

on:
  issues:
    types: [opened, edited]
  workflow_call:
    secrets:
      COPILOT_TOKEN:
        description: 'GitHub PAT with Copilot access'
        required: true

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      - name: Use Copilot to analyze issue and add labels
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          PIPELINE_TOKEN: ${{ github.token }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          # Fetch all area labels from the repository
          AREA_LABELS=$(GH_TOKEN=$PIPELINE_TOKEN gh label list --repo $REPO --search "Area -" --limit 100 --json name --jq '.[].name' | tr '\n' ', ' | sed 's/, $//')

          echo "Available area labels: $AREA_LABELS"

          # Ask Copilot to generate and execute the gh issue edit command
          copilot -p "Analyze this GitHub issue and generate a 'gh issue edit' command to add appropriate labels.

          Issue Number: $ISSUE_NUMBER
          Repository: $REPO
          Issue Title: $ISSUE_TITLE
          Issue Body: $ISSUE_BODY

          Available Area Labels: $AREA_LABELS
          Also add 'bug' or 'enhancement' label based on the issue type.

          IMPORTANT: When generating the gh command, prefix it with 'GH_TOKEN=\$PIPELINE_TOKEN' to use the pipeline token for authentication.
          Generate and execute the gh issue edit command with --add-label flags." --allow-all-tools
