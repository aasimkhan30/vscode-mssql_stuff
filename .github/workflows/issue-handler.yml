name: Issue Handler

on:
  issues:
    types: [opened, edited]
  workflow_call:
    secrets:
      COPILOT_TOKEN:
        description: "GitHub PAT with Copilot access"
        required: true

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone repository copy
        run: git clone . repo-clone

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      - name: Use Copilot to analyze issue and add labels
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          PIPELINE_TOKEN: ${{ github.token }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          # Fetch all area labels from the repository
          AREA_LABELS=$(GH_TOKEN=$PIPELINE_TOKEN gh label list --repo $REPO --search "Area -" --limit 100 --json name --jq '.[].name' | tr '\n' ', ' | sed 's/, $//')

          echo "Available area labels: $AREA_LABELS"

          # Fetch all open issues and save to JSON file
          GH_TOKEN=$PIPELINE_TOKEN gh issue list --repo $REPO --state open --limit 500 --json number,title,body,labels,url > open_issues.json
          echo "Fetched $(cat open_issues.json | jq '. | length') open issues"

          # Ask Copilot to analyze and handle the issue
          copilot -p "Analyze this GitHub issue and perform the following tasks:

          Issue Number: $ISSUE_NUMBER
          Repository: $REPO
          Issue Title: $ISSUE_TITLE
          Issue Body: $ISSUE_BODY

          Available Area Labels: $AREA_LABELS

          Tasks:
          1. Check if the issue has enough information. ONLY if there isn't enough info, add 'needs more info' label and post a context-aware comment that:
             - Specifically identifies what information is missing from the issue
             - Asks targeted questions based on the issue type (e.g., for bugs: reproduction steps, for features: use case)
             - Requests additional helpful details like:
               * Steps to reproduce (if bug report)
               * Expected vs actual behavior (if not clear)
               * Version information (extension, VS Code, SQL Server/database version)
               * Error messages, stack traces, or screenshots
               * Database connection details (type, authentication method - without credentials)
             - Suggests what else might be helpful based on the issue context
             - Keep the tone friendly and helpful
             Use: GH_TOKEN=\$PIPELINE_TOKEN gh issue comment $ISSUE_NUMBER --repo $REPO --body '<your personalized comment>'
          2. Search for duplicate issues:
             - Read the open_issues.json file which contains all open issues
             - Analyze the issues to find duplicates by comparing:
               * Similar error messages or stack traces
               * Same feature requests
               * Identical symptoms or behaviors described
               * Similar technical components mentioned
             - If you find actual duplicates (issues describing the exact same problem), add a comment with: GH_TOKEN=\$PIPELINE_TOKEN gh issue comment $ISSUE_NUMBER --repo $REPO --body 'Possible duplicates found:\n- #<number>: <title>\n- #<number>: <title>\n\nPlease check if any of these match your issue.'
             - Only add 'duplicate' label if you're very confident it's a duplicate of a specific issue
          3. Analyze where the bug is most likely located based on the issue context and repository knowledge. Post a comment that lists the top 5 most relevant files or specific code lines to investigate, with a short explanation for each. Use: GH_TOKEN=\$PIPELINE_TOKEN gh issue comment $ISSUE_NUMBER --repo $REPO --body '<your analysis with top 5 files/lines>'
          4. Add appropriate area label from: $AREA_LABELS
          5. Add 'bug' or 'enhancement' label based on issue type.

          IMPORTANT: Prefix ALL gh commands with 'GH_TOKEN=\$PIPELINE_TOKEN' for authentication.
          Execute all necessary commands." --allow-all-tools
