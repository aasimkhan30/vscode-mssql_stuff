name: Issue Handler

on:
  issues:
    types: [opened, edited]

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
      copilot: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      - name: Use Copilot to analyze issue and add labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          # Use GitHub Copilot CLI to analyze the issue and determine area label
          AREA_PROMPT="Based on this issue, determine the most appropriate area. Choose from: Editor, Query, Connection, ObjectExplorer, Debugging, Performance, Telemetry, UI, Security, Database, Configuration, Authentication, Extension. Only respond with ONE area name.

          Title: $ISSUE_TITLE

          Body: $ISSUE_BODY"

          # Ask Copilot for the area
          AREA_NAME=$(echo "$AREA_PROMPT" | copilot suggest -t shell | grep -v "^#" | tail -1)

          AREA_LABEL="Area - $AREA_NAME"
          echo "Determined area label: $AREA_LABEL"

          # Determine if it's a bug or enhancement
          TYPE_PROMPT="Based on this issue, is it a bug report or a feature/enhancement request? Only respond with 'bug' or 'enhancement'.

          Title: $ISSUE_TITLE

          Body: $ISSUE_BODY"

          TYPE=$(echo "$TYPE_PROMPT" | copilot suggest -t shell | grep -v "^#" | tail -1 | tr '[:upper:]' '[:lower:]')

          echo "Determined type: $TYPE"

          # Add the labels to the issue
          if [ -n "$AREA_LABEL" ]; then
            gh issue edit $ISSUE_NUMBER --repo $REPO --add-label "$AREA_LABEL"
            echo "Added label $AREA_LABEL to issue #$ISSUE_NUMBER"
          fi

          if [ -n "$TYPE" ]; then
            gh issue edit $ISSUE_NUMBER --repo $REPO --add-label "$TYPE"
            echo "Added label $TYPE to issue #$ISSUE_NUMBER"
          fi
