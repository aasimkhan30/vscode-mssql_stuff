name: Issue Handler

on:
  issues:
    types: [opened, edited]
  workflow_call:
    secrets:
      COPILOT_TOKEN:
        description: "GitHub PAT with Copilot access"
        required: true

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot

      - name: Use Copilot to analyze issue and add labels
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          PIPELINE_TOKEN: ${{ github.token }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          # Fetch all area labels from the repository
          AREA_LABELS=$(GH_TOKEN=$PIPELINE_TOKEN gh label list --repo $REPO --search "Area -" --limit 100 --json name --jq '.[].name' | tr '\n' ', ' | sed 's/, $//')

          echo "Available area labels: $AREA_LABELS"

          # Ask Copilot to analyze and handle the issue
          copilot -p "Analyze this GitHub issue and perform the following tasks:

          Issue Number: $ISSUE_NUMBER
          Repository: $REPO
          Issue Title: $ISSUE_TITLE
          Issue Body: $ISSUE_BODY

          Available Area Labels: $AREA_LABELS

          Tasks:
          1. Check if the issue has enough information. ONLY if there isn't enough info, add 'needs more info' label and post a context-aware comment that:
             - Specifically identifies what information is missing from the issue
             - Asks targeted questions based on the issue type (e.g., for bugs: reproduction steps, for features: use case)
             - Requests additional helpful details like:
               * Steps to reproduce (if bug report)
               * Expected vs actual behavior (if not clear)
               * Version information (extension, VS Code, SQL Server/database version)
               * Error messages, stack traces, or screenshots
               * Database connection details (type, authentication method - without credentials)
             - Suggests what else might be helpful based on the issue context
             - Keep the tone friendly and helpful
             Use: GH_TOKEN=\$PIPELINE_TOKEN gh issue comment $ISSUE_NUMBER --repo $REPO --body '<your personalized comment>'
          2. Search for duplicate issues by:
             - Extracting key technical terms, error messages, and feature descriptions from the issue
             - Searching using: GH_TOKEN=\$PIPELINE_TOKEN gh issue list --repo $REPO --search 'is:issue <relevant keywords>' --limit 20 --json number,title,url,body
             - Analyzing the results to identify true duplicates (not just related issues)
             - ONLY if you find actual duplicates with the same core problem, add a comment listing them with: GH_TOKEN=\$PIPELINE_TOKEN gh issue comment $ISSUE_NUMBER --repo $REPO --body 'Possible duplicates:\n- #<number>: <title> (<url>)\n...'
             - Add 'duplicate' label only if highly confident it's a duplicate
          4. Add appropriate area label from: $AREA_LABELS
          5. Add 'bug' or 'enhancement' label based on issue type.

          IMPORTANT: Prefix ALL gh commands with 'GH_TOKEN=\$PIPELINE_TOKEN' for authentication.
          Execute all necessary commands." --allow-all-tools
